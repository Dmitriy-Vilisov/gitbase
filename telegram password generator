import secrets
import telebot
from telebot import types
import time

class PwdEngine:
    LOWERCASE = 'abcdefghijklmnopqrstuvwxyz'
    UPPERCASE = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
    DIGITS = '0123456789'
    PUNCTUATIONS = '!#$%&()*+-<=>?[]_{}'
    send = ['abc', 'ABC', '123']  # Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
    lenght = 20                   # Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ

    def __init__(self, send, lenght):
        self.send = send
        self.lenght = lenght

    def get_lenght(self):
        return self.lenght

    def get_send(self):
        return self.send

    def set_send(self, send):
        if len(send) > 0:  # Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ 1 Ð½Ð°Ð±Ð¾Ñ€
            self.send = send
            '''else:
            bot.send_message(message.chat.id, text=f'Ð’Ñ‹ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð½Ð°Ð±Ð¾Ñ€Ñ‹, Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð²Ñ‹ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð½Ð° ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ')
            self.send = ['abc', 'ABC', '123']'''

    @staticmethod
    def pwdgen(lenght, send):
        for n, i in enumerate(send):
            # Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ð¸Ð¿ Ñ‡Ð¸ÑÐ»Ð°
            if i == 'abc':
                send[n] = PwdEngine.LOWERCASE
            if i == 'ABC':
                send[n] = PwdEngine.UPPERCASE
            if i == '123':
                send[n] = PwdEngine.DIGITS
            if i == '*!#':
                send[n] = PwdEngine.PUNCTUATIONS
        password_items = "".join(send)
        password = ''.join(secrets.SystemRandom().sample(password_items, lenght))
        while not PwdEngine.password_correction(password, password_items):
            password = ''.join(secrets.SystemRandom().sample(password_items, lenght))
        else:
            return password

    @staticmethod
    def password_correction(password, password_items):
        count_punctuations = 0
        count_digits = 0
        count_lowercase = 0
        count_uppercase = 0
        # for count punctuation symbols in password
        if PwdEngine.PUNCTUATIONS in password_items:        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð·Ð½Ð°ÐºÐ¾Ð² Ð² password_items
            for symbol in password:
                if symbol in PwdEngine.PUNCTUATIONS:
                    count_punctuations += 1
        else:
            count_punctuations = round(len(password) / 4)  # Ð•ÑÐ»Ð¸ Ð·Ð½Ð°ÐºÐ¾Ð² Ð½ÐµÑ‚, Ð´ÐµÐ»Ð°ÐµÐ¼ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ Ð½Ð¸Ð¶Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ñ‹Ð¼
        
        if PwdEngine.DIGITS in password_items:             # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‡Ð¸ÑÐµÐ» Ð² password_items
            for symbol in password:
                if symbol in PwdEngine.DIGITS:
                    count_digits += 1
        else:
            count_digits = 1
        if PwdEngine.LOWERCASE and PwdEngine.UPPERCASE in password_items:  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‡Ð¸ÑÐµÐ» Ð² password_items
            for symbol in password:
                if symbol in PwdEngine.LOWERCASE:
                    count_lowercase += 1
                if symbol in PwdEngine.UPPERCASE:
                    count_uppercase += 1
            # Ð•ÑÐ»Ð¸ Ñ‡Ð¸ÑÐµÐ» Ð½ÐµÑ‚, Ð´ÐµÐ»Ð°ÐµÐ¼ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ Ð½Ð¸Ð¶Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ñ‹Ð¼

        if (PwdEngine.LOWERCASE or PwdEngine.UPPERCASE) in password_items:
            if password[0:2] in PwdEngine.LOWERCASE + PwdEngine.UPPERCASE \
                    and (count_punctuations == round(len(password) / 4)) \
                    and (count_digits != 0):
                if (PwdEngine.LOWERCASE and PwdEngine.UPPERCASE) in password_items:
                    if count_lowercase > 0 and count_uppercase > 0:  # ÐµÑÐ»Ð¸ Ð¸ lower Ð¸ upper, Ñ‚Ð¾ Ð¾Ð½Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð¿Ð°Ñ€Ð¾Ð»Ðµ
                        return True  # Ð¸Ð½Ð°Ñ‡Ðµ Ð¿Ñ€Ð¸ Ð´Ð»Ð¸Ð½Ðµ 4-6 Ð¼Ð¾Ð³ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð°Ñ‚ÑŒÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ 1 Ð½Ð°Ð±Ð¾Ñ€
                else:
                    return True
        elif password_items == PwdEngine.DIGITS:  # ÐµÑÐ»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ†Ð¸Ñ„Ñ€Ñ‹ - Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð· Ð½Ð¸Ñ…
            return True
        else:
            if (password[0:2] in PwdEngine.DIGITS) \
                    and (count_punctuations > 1) and (count_punctuations <= round(len(password) / 2)):
                return True  # Ð•ÑÐ»Ð¸ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð½Ð°Ñ‡Ð°Ð»Ðµ Ð´Ð²Ðµ Ð±ÑƒÐºÐ²Ñ‹, Ð±ÑƒÐ´ÑƒÑ‚ 2 Ñ†Ð¸Ñ„Ñ€Ñ‹


bot = telebot.TeleBot("5931312481:AAEsYuxpAs4Lxt_48LxbjLIlHcjdzzPQyaA")

store_button_clicked = ['abc', 'ABC', '123']


# Ð‘Ð»Ð¾Ðº Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° Ð² Ð¼ÐµÐ½ÑŽ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
def main_menu(message):
    keyboard_1 = types.InlineKeyboardMarkup()
    callback_button_1 = types.InlineKeyboardButton(text="ÐšÐ½Ð¾Ð¿ÐºÐ°1", callback_data="knopka1")
    keyboard_1.add(callback_button_1)
    return start_func(message)


# Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ð±Ð»Ð¾Ðº Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¾Ð¹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸
@bot.message_handler(commands=['start'])
def start_func(message):
    # if message.text in '/start':
    bot.send_message(message.chat.id,
                     text=f'ðŸ‘‹ Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ, {message.from_user.first_name}! \n\n Ð¯ ÑƒÐ¼ÐµÑŽ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ '
                          'ÑÐ»Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ð¸, Ð´Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¼ÐµÐ½Ñ Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼! ðŸ‘€ ')
    kb_start_func = types.InlineKeyboardMarkup()
    btn0 = types.InlineKeyboardButton(text='Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ ðŸš€', callback_data='btn0')
    kb_start_func.add(btn0)
    bot.send_message(message.chat.id, f'Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð»Ð¸Ð½Ð° Ð¿Ð°Ñ€Ð¾Ð»Ñ: {PwdEngine.lenght} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²',
                     reply_markup=kb_start_func)

    @bot.callback_query_handler(func=lambda call: call.data == 'btn0')
    def check_start_func(call):
        if call.data == 'btn0':
            bot.send_message(call.message.chat.id, f"Ð’Ð°Ñˆ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ:  {PwdEngine.pwdgen(PwdEngine.lenght, PwdEngine.send)}")


# Ð‘Ð»Ð¾Ðº Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
@bot.message_handler(commands=['settings'])
def func_settings(message):
    kb_settings = types.InlineKeyboardMarkup()
    btn6 = types.InlineKeyboardButton(text='Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð´Ð»Ð¸Ð½Ñƒ Ð¿Ð°Ñ€Ð¾Ð»Ñ', callback_data='btn6')
    btn7 = types.InlineKeyboardButton(text='Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð°Ð±Ð¾Ñ€Ñ‹ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²', callback_data='btn7')
    btn8 = types.InlineKeyboardButton(text='ÐÐ²Ñ‚Ð¾ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¿Ð°Ñ€Ð¾Ð»Ñ', callback_data='btn8')
    btn9 = types.InlineKeyboardButton(text='ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸ Ð¾ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸', callback_data='btn9')
    btn10 = types.InlineKeyboardButton(text='Ð¡Ð±Ñ€Ð¾Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº', callback_data='btn10')
    btn11 = types.InlineKeyboardButton(text='ðŸ”™ Ð’ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ', callback_data='btn11')
    kb_settings.add(btn6, btn7, btn8, btn9, btn10, btn11)
    bot.send_message(message.chat.id, 'ðŸ›  ÐœÐµÐ½ÑŽ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº ðŸ› ', reply_markup=kb_settings)

    # ÐŸÐ¾Ð´Ð±Ð»Ð¾Ðº Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¹ Ð½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
    @bot.callback_query_handler(func=lambda call: call.data == 'btn[0-7]' or 'all_reset' or 'main')
    # Ð•Ð¡Ð›Ð˜ Ð—ÐÐ”ÐÐ¢Ð¬ Ð ÐÐ—ÐÐ«Ð• Ð£Ð¡Ð›ÐžÐ’Ð˜Ð¯ Ð¡Ð ÐÐ‘ÐÐ¢Ð«Ð’ÐÐÐ˜Ð¯ Ð’ call-Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¸, Ð¢Ðž Ð’Ð¡Ð• Ð‘Ð£Ð”Ð•Ð¢ Ð ÐÐ‘ÐžÐ¢ÐÐ¢Ð¬ Ð˜Ð¡ÐŸÐ ÐÐ’ÐÐž
    def check_start_func(call):
        if call.data == 'btn0':
            bot.send_message(call.message.chat.id, f"Ð’Ð°Ñˆ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ:  {PwdEngine.pwdgen(PwdEngine.lenght, PwdEngine.send)}")
        if call.data == 'btn6':
            bot.send_message(call.message.chat.id, f'Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¶ÐµÐ»Ð°ÐµÐ¼ÑƒÑŽ Ð´Ð»Ð¸Ð½Ñƒ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¾Ñ‚ 4 Ð´Ð¾ 65 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²!')
        elif call.data == 'btn7':
            kb_storage = types.InlineKeyboardMarkup()
            btn1 = types.InlineKeyboardButton(text='abc..', callback_data='btn1')
            btn2 = types.InlineKeyboardButton(text='ABC..', callback_data='btn2')
            btn3 = types.InlineKeyboardButton(text='123..', callback_data='btn3')
            btn4 = types.InlineKeyboardButton(text='!*#..', callback_data='btn4')
            all_reset = types.InlineKeyboardButton(text='Ð²ÑÐµ/Ð½Ð¸Ñ‡ÐµÐ³Ð¾', callback_data='all_reset')
            btn5 = types.InlineKeyboardButton(text='Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!', callback_data='btn5')
            kb_storage.add(btn1, btn2, btn3, btn4, all_reset, btn5)
            bot.send_message(call.message.chat.id, 'Ð’Ñ‹Ð±ÐµÑ€ÐµÑ‚Ðµ Ð½Ð°Ð±Ð¾Ñ€Ñ‹ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ:',
                             reply_markup=kb_storage)
        elif call.data == 'btn1':
            if 'abc' not in store_button_clicked:  # Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ/ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð½Ð°Ð±Ð¾Ñ€Ð¾Ð² Ð¸Ð· Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°
                store_button_clicked.append('abc')
            else:
                store_button_clicked.remove('abc')
        elif call.data == 'btn2':
            if 'ABC' not in store_button_clicked:
                store_button_clicked.append('ABC')
            else:
                store_button_clicked.remove('ABC')
        elif call.data == 'btn3':
            if '123' not in store_button_clicked:
                store_button_clicked.append('123')
            else:
                store_button_clicked.remove('123')
        elif call.data == 'btn4':
            if '*!#' not in store_button_clicked:
                store_button_clicked.append('*!#')
            else:
                store_button_clicked.remove('*!#')
        elif call.data == 'all_reset':
            if len(store_button_clicked) == 0:
                store_button_clicked.append('abc')
                store_button_clicked.append('ABC')
                store_button_clicked.append('123')
                store_button_clicked.append('*!#')
            else:
                store_button_clicked.clear()
        elif call.data == 'btn5':
            bot.send_message(call.message.chat.id, f'Ð’Ñ‹Ð±Ñ€Ð°Ð½Ñ‹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð½Ð°Ð±Ð¾Ñ€Ñ‹: {", ".join(store_button_clicked)}')
            PwdEngine.send = store_button_clicked.copy()  # Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð° Ð² Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÐºÐ¾Ð¿Ð¸Ð¸ ÑÐ¿Ð¸ÑÐºÐ° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð°Ð±Ð¾Ñ€Ð¾Ð²

            kb_check_storage = types.InlineKeyboardMarkup(row_width=1)
            main = types.InlineKeyboardButton(text='Ð’ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ', callback_data='main')
            re_btn7 = types.InlineKeyboardButton(text='Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ð¾Ñ€', callback_data='btn7')
            kb_check_storage.add(main, re_btn7)
            bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.id,
                                  text='Ð’Ñ‹Ð±ÐµÑ€ÐµÑ‚Ðµ ''Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐ¸Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ: ', reply_markup=kb_check_storage)
        elif call.data == 'main':
            bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id,
                                  text='Ð²Ñ‹ Ð²ÐµÑ€Ð½ÑƒÐ»Ð¸ÑÑŒ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ', reply_markup=main_menu(message))


@bot.message_handler(content_types=['text'])
def f(message):
    min_max_len = list(map(str, range(4, 66)))  # Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ð°Ñ Ð´Ð»Ð¸Ð½Ð° Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¾Ñ‚ 4 Ð´Ð¾ 70 Ñ.
    if message.text in min_max_len:   # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð²Ð²Ð¾Ð´Ð°. Ð’ Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑƒÐ´Ð¾Ð²Ð»ÐµÑ‚Ð²Ð¾Ñ€ÑÑŽÑ‰ÐµÐµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
        new_len_psw = min_max_len.index(message.text) + 4
        print(new_len_psw)
        bot.send_message(message.chat.id, text=f'ÐžÐºÐµÐ¹, Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð´Ð»Ð¸Ð½Ð° Ð¿Ð°Ñ€Ð¾Ð»Ñ {new_len_psw} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²!')
        PwdEngine.lenght = new_len_psw  # Ð²Ð²ÐµÐ´ÐµÐ½Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð´Ð»Ð¸Ð½Ñ‹ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ÑÑ Ð² Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€, Ð·Ð°Ð¼ÐµÐ½ÑÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ðµ


while True:
    try:
        bot.polling(none_stop=True)

    except Exception as e:
        print(e)
        time.sleep(5)
